<VirtualHost *:80>
    ServerAdmin jjdavis@email.arizona.edu
    ServerName ehipdev.arl.arizona.edu

    RewriteEngine on
    RewriteCond "%{HTTP_HOST}" "^ehipdev\.arl\.arizona\.edu" [NC]
    RewriteCond "%{REQUEST_URI}" "!^(/\.well-known/.*)" [NC]
    RewriteRule "^/(.*)"  "https://ehipdev.arl.arizona.edu/$1" [QSA,NC,R=302]

    # For the Let's Encrypt SSL certificate
    Alias /.well-known/acme-challenge/ /usr/local/etc/acme-challenges/ehipdev.arl.arizona.edu/
    <Directory /usr/local/etc/acme-challenges/ehipdev.arl.arizona.edu>
      AllowOverride None
      Require all granted
    </Directory>
</VirtualHost>

<VirtualHost *:443>
    ServerName ehipdev.arl.arizona.edu

    DocumentRoot /var/www/spacetrace-stg

    # For the Let's Encrypt SSL certificate
    Alias /.well-known/acme-challenge/ /usr/local/etc/acme-challenges/spacetrace-stg.arl.arizona.edu/
    <Directory /usr/local/etc/acme-challenges/spacetrace-stg.arl.arizona.edu>
      AllowOverride None
      Require all granted
    </Directory>

    SSLEngine on
    SSLCertificateKeyFile /usr/local/etc/letsencrypt/ehipdev.arl.arizona.edu/domain.key
    SSLCertificateFile /usr/local/etc/letsencrypt/ehipdev.arl.arizona.edu/chained.pem
    SSLCertificateChainFile /usr/local/etc/letsencrypt/ehipdev.arl.arizona.edu/chained.pem

    WSGIDaemonProcess ehipdev.arl.arizona.edu processes=2 threads=10 inactivity-timeout=60 python-path=/var/webapps/spacetrace-stg:/var/webapps/spacetrace-stg/bcfsrc:/var/webapps/spacetrace-stg/envs/spacetrace-stg/lib/python2.7/site-packages display-name=%{GROUP}
    WSGIPassAuthorization On
    WSGIProcessGroup ehipdev.arl.arizona.edu
    #WSGIRestrictEmbedded On
    #WSGILazyInitialization On
    WSGIScriptAlias / "/var/webapps/spacetrace-stg/etc/apache2/spacetrace-stg.wsgi"
    <Directory /var/django/spacetrace-stg/etc/apache2>
        # Require all granted
        <Files webapps-stg.wsgi>
          Options +ExecCGI
          Require all granted
        </Files>
    </Directory>
      
    <Location /m>
      AuthType Basic
      AuthName "Restricted Access (Software developers only)"
      # (Following line optional)
      AuthBasicProvider file
      AuthUserFile "/etc/apache2/passwd/passwords"
      Require user bcfadmin
    </Location>
    <Location /admin>
      AuthType Basic
      AuthName "Restricted Access (Software developers only)"
      # (Following line optional)
      AuthBasicProvider file
      AuthUserFile "/etc/apache2/passwd/passwords"
      Require user bcfadmin
    </Location>

    # Fix for Invalid HTTP_HOST header:
    <If "%{HTTP_HOST} != 'ehipdev.arl.arizona.edu'">
      Require all denied
    </If>

    <Directory /var/www/spacetrace-stg>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Require all granted

        # Protect files and directories from prying eyes.
        <FilesMatch "\.(engine|inc|info|install|make|module|profile|test|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(\..*|Entries.*|Repository|Root|Tag|Template)$">
            Require all denied
        </FilesMatch>

        # Don't show directory listings for URLs which map to a directory.
        Options -Indexes

        # Follow symbolic links in this directory.
        Options +FollowSymLinks

        # Multiviews creates problems with aliased URLs and is not needed for Drupal.
        Options -Multiviews


        <IfModule mod_expires.c>
          # Enable expirations.
          ExpiresActive On

          # Cache all files for 2 weeks after access (A).
          ExpiresDefault A1209600
        </IfModule>

        <IfModule mod_rewrite.c>
          RewriteEngine on
          # Block access to "hidden" directories whose names begin with a period. This
          # Allow .well-known folders
          RewriteCond %{REQUEST_URI} !/\.well-known/.*$
          # Allow .thumbnails directories
          RewriteCond %{REQUEST_URI} !/\.thumbnails/.*$
          # Block all other . files and directories
          RewriteRule (^\.|/\.) - [F]
        </IfModule>

    </Directory>

    Alias /robots.txt /var/www/spacetrace-stg/robots.txt
    Alias /favicon.ico /var/www/spacetrace-stg/favicon.ico
    Alias /static /var/www/spacetrace-stg/static
    Alias /media /var/www/spacetrace-stg/media

    # ErrorDocument 500 /var/www/spacetrace-stg/static/base_theme/500-error/index.html

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog /var/log/apache2/spacetrace-stg-access.log combined
    ErrorLog /var/log/apache2/spacetrace-stg-error.log

</VirtualHost>

# From https://mozilla.github.io/server-side-tls/ssl-config-generator/
# (But Ubuntu doesn't grok SSLSessionTickets)

SSLProtocol             all -SSLv3 -TLSv1
SSLCipherSuite          ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK
SSLHonorCipherOrder     on
SSLCompression          off
#    SSLSessionTickets       off

# OCSP Stapling, only in httpd 2.3.3 and later
# SSLStaplingCache shmcb:/var/tmp/ocsp-stapling-cache/cache(128000000)
# SSLUseStapling on
# SSLStaplingResponderTimeout 2
# SSLStaplingReturnResponderErrors off
# SSLStaplingFakeTryLater off
# SSLStaplingStandardCacheTimeout 86400